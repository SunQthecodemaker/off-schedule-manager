# AppSheet 연동 통합 기획서

## 1. 개요 및 목표
현재 사용 중인 웹 기반 연차/스케줄 관리 시스템(Supabase DB)과, 새로 구축된 AppSheet 기반 스케줄 생성기(Google Sheets DB)를 연동하여 업무 효율을 높입니다.
기존 웹 시스템의 안정성을 유지하면서, 스케줄 생성의 편의성(AppSheet)을 활용하는 것이 목표입니다.

## 2. 데이터 흐름 (Data Flow)

연동은 크게 두 가지 방향으로 이루어집니다.

### A. 웹(Supabase) ➔ AppSheet (데이터 전송)
스케줄을 짜기 위한 **기초 데이터**를 보냅니다.
1. **직원 정보**: 이름, 부서, 입사일 등 (임시직 제외, 퇴사자 제외)
2. **연차 정보**: 관리자가 승인한 확정된 연차 (스케줄 생성 시 근무 제외 처리를 위함)

### B. AppSheet ➔ 웹(Supabase) (결과 반영)
AppSheet에서 생성하고 확정한 **최종 스케줄**을 가져옵니다.
1. **스케줄 데이터**: 날짜, 직원, 근무 여부
2. **반영 방식**: 웹 시스템의 해당 월 스케줄 데이터를 **덮어쓰기** (Overwrite)

---

## 3. 상세 프로세스

### 1단계: 준비 (웹)
- 관리자는 [직원 관리] 탭에서 직원 목록을 최신화합니다.
- 관리자는 [연차 관리] 탭에서 접수된 연차를 승인하거나 반려하여 확정합니다.

### 2단계: 데이터 전송 (웹 ➔ 시트)
- **Action**: 웹 스케줄 탭 상단의 `[AppSheet 연동]` > `[데이터 전송]` 버튼 클릭
- **Process**:
  1. Supabase에서 유효한 직원 목록과 해당 월(및 전후) 승인된 연차를 조회합니다.
  2. Google Apps Script(GAS) API를 호출하여 `Data` 시트(직원)와 `Leaves` 시트(연차)를 갱신합니다.
- **Result**: 구글 시트가 최신 데이터로 업데이트됩니다.

### 3단계: 스케줄 생성 (AppSheet)
- 관리자는 AppSheet(또는 구글 시트)에서 스케줄을 생성합니다.
- 이때 GAS 로직이 `Leaves` 시트의 연차 데이터를 참조하여, 연차인 직원은 근무에서 자동 제외합니다.
- 생성 후 `[스케줄 확정]` 기능을 수행하여 `YYYY-MM-DD_확정본` 시트를 생성합니다.

### 4단계: 스케줄 가져오기 (시트 ➔ 웹)
- **Action**: 웹 스케줄 탭 상단의 `[AppSheet 연동]` > `[스케줄 가져오기]` 버튼 클릭
- **Process**:
  1. 웹앱이 GAS API를 통해 현재 월의 `확정본` 시트 데이터를 요청합니다.
  2. 받아온 데이터를 분석하여 직원 ID와 매칭합니다.
  3. Supabase의 `schedules` 테이블에서 해당 월의 기존 데이터를 삭제하고, 가져온 데이터로 새로 생성합니다.
- **Result**: 웹사이트와 직원 포털에서도 AppSheet에서 짠 스케줄을 확인할 수 있게 됩니다.

---

## 4. 안전 장치 (Risk Management)

1. **백업 (Backup)**
   - 스케줄 가져오기(덮어쓰기) 실행 전, 사용자에게 명시적인 **경고 창(Confirm)**을 띄웁니다.
   - 필요 시 가져오기 직전에 기존 스케줄을 별도 백업 테이블(`schedules_backup`)에 저장하는 로직을 추가할 수 있습니다. (추후 구현 가능)

2. **직원 매칭 오류 방지**
   - AppSheet의 이름과 Supabase의 이름이 다를 경우(오타 등)를 대비해, 이름 불일치 시 **에러 리포트**를 띄우고 해당 데이터는 가져오지 않습니다.
   - 동명이인 처리를 위해 가급적 사번(ID)을 함께 사용하는 것이 좋으나, 현재 시트 구조상 **이름**을 키(Key)로 사용합니다.

3. **기존 기능 보존**
   - AppSheet 연동은 "선택 사항"입니다. 연동을 안 하더라도 기존의 Drag & Drop 스케줄링 기능은 100% 동일하게 작동합니다.

---

## 5. 구현 계획

이미 작업 파일(`APP_SHEET_INTEGRATION_GUIDE.md`, `appsheet-client.js`)을 생성했으며, `index.html`과 `schedule.js`에 UI를 연동해 두었습니다.
사용자 검토 후 바로 적용 가능합니다.
