// schedule.js - ÏàòÏ†ïÎêú Î≤ÑÏ†Ñ
import { state, db } from './state.js';
import { _, show, hide } from './utils.js';

let unsavedChanges = new Map();
let unsavedHolidayChanges = { toAdd: new Set(), toRemove: new Set() };
state.schedule.activeDepartmentFilters = new Set();
state.schedule.companyHolidays = new Set();
state.schedule.activeReorder = {
    date: null,
    sortable: null,
};

// ‚ú® ÌÅ¥Î¶≠Í≥º ÎìúÎûòÍ∑∏ Íµ¨Î∂ÑÏùÑ ÏúÑÌïú Î≥ÄÏàò
let isDragging = false;
let dragStartTime = 0;

function updateScheduleSortOrders(dateStr) {
    const dayEl = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
    if (!dayEl) return;
    const eventContainer = dayEl.querySelector('.day-events');
    if (!eventContainer) return;
    
    const orderedIds = [];
    const eventCards = eventContainer.querySelectorAll('.event-card');
    eventCards.forEach(card => {
        const empId = parseInt(card.dataset.employeeId, 10);
        if (!isNaN(empId)) orderedIds.push(empId);
    });
    
    orderedIds.forEach((employeeId, index) => {
        let schedule = state.schedule.schedules.find(s => s.date === dateStr && s.employee_id === employeeId);
        if (schedule) {
            if (schedule.sort_order !== index) {
                schedule.sort_order = index;
                unsavedChanges.set(schedule.id, { type: 'update', data: schedule });
            }
        } else {
            const tempId = `temp-${Date.now()}-${employeeId}`;
            const newSchedule = { 
                id: tempId, 
                date: dateStr, 
                employee_id: employeeId, 
                status: 'Í∑ºÎ¨¥', 
                sort_order: index
            };
            state.schedule.schedules.push(newSchedule);
            unsavedChanges.set(tempId, { type: 'new', data: newSchedule });
        }
    });
}

function getDepartmentColor(departmentId) {
    if (!departmentId) return '#cccccc';
    const colors = ['#4f46e5', '#db2777', '#16a34a', '#f97316', '#0891b2', '#6d28d9', '#ca8a04'];
    return colors[departmentId % colors.length];
}

function getSpacerHtml() {
    return `<div class="list-spacer" data-type="spacer"><span class="handle">‚ò∞</span><button class="delete-spacer-btn" title="Îπà Ïπ∏ ÏÇ≠Ï†ú">√ó</button></div>`;
}

function getSeparatorHtml() {
    return `<div class="list-separator flex items-center" data-type="separator"><span class="handle">‚ò∞</span><div class="line"></div><button class="delete-separator-btn" title="Íµ¨Î∂ÑÏÑ† ÏÇ≠Ï†ú">√ó</button></div>`;
}

function getEmployeeHtml(emp) {
    if (!emp) return '';
    const departmentColor = getDepartmentColor(emp.departments?.id);
    return `<div class="draggable-employee" data-employee-id="${emp.id}" data-type="employee"><span class="handle">‚ò∞</span><div class="fc-draggable-item"><span style="background-color: ${departmentColor};" class="department-dot"></span><span class="flex-grow font-semibold">${emp.name}</span></div></div>`;
}

function getFilteredEmployees() {
    const { employees } = state.management;
    const { activeDepartmentFilters } = state.schedule;
    if (activeDepartmentFilters.size === 0) return employees;
    return employees.filter(emp => activeDepartmentFilters.has(emp.department_id));
}

function getTeamHtml(team, allEmployees) {
    const deleteButton = `<button class="delete-team-btn ml-auto text-red-500 hover:text-red-700 disabled:opacity-25" data-team-id="${team.id}" title="ÌåÄÏù¥ ÎπÑÏñ¥ÏûàÏùÑ ÎïåÎßå ÏÇ≠Ï†ú Í∞ÄÎä•" ${team.members.length > 0 ? 'disabled' : ''}>üóëÔ∏è</button>`;
    const membersHtml = team.members.map(memberId => {
        if (memberId === '---separator---') return getSeparatorHtml();
        if (memberId === '---spacer---') return getSpacerHtml();
        const emp = allEmployees.find(e => e.id === memberId);
        return emp ? getEmployeeHtml(emp) : '';
    }).join('');
    return `<div class="team-group" data-team-id="${team.id}"><div class="team-header"><span class="handle">‚ò∞</span><input type="text" class="team-header-input" value="${team.name}">${deleteButton}</div><div class="team-member-list">${membersHtml}</div></div>`;
}

function updateSaveButtonState() {
    const saveBtn = _('#save-schedule-btn');
    const revertBtn = _('#revert-schedule-btn');
    if (!saveBtn || !revertBtn) return;
    const totalChanges = unsavedChanges.size + unsavedHolidayChanges.toAdd.size + unsavedHolidayChanges.toRemove.size;
    if (totalChanges > 0) {
        saveBtn.disabled = false;
        revertBtn.disabled = false;
        saveBtn.textContent = `üíæ Ïä§ÏºÄÏ§Ñ Ï†ÄÏû• (${totalChanges}Í±¥)`;
    } else {
        saveBtn.disabled = true;
        revertBtn.disabled = true;
        saveBtn.textContent = 'üíæ Ïä§ÏºÄÏ§Ñ Ï†ÄÏû•';
    }
}

function updateViewModeButtons() {
    const { viewMode } = state.schedule;
    document.querySelectorAll('.schedule-view-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === viewMode));
}

function handleViewModeChange(e) {
    const btn = e.target.closest('.schedule-view-btn');
    if (!btn) return;
    const newMode = btn.dataset.mode;
    if (state.schedule.viewMode !== newMode) {
        state.schedule.viewMode = newMode;
        updateViewModeButtons();
        renderCalendar();
    }
}

async function handleRevertChanges() {
    if (confirm("Ï†ïÎßêÎ°ú Î™®Îì† Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ ÎêòÎèåÎ¶¨ÏãúÍ≤†ÏäµÎãàÍπå?")) {
        await loadAndRenderScheduleData(state.schedule.currentDate);
    }
}

async function handleSaveSchedules() {
    _('#save-schedule-btn').disabled = true;
    _('#save-schedule-btn').textContent = 'Ï†ÄÏû• Ï§ë...';

    const toInsert = [], toUpdate = new Map(), toDelete = [];
    for (const [id, change] of unsavedChanges.entries()) {
        if (change.type === 'new') {
            // ‚ú® temp ID Ï†úÍ±∞ÌïòÍ≥† Îç∞Ïù¥ÌÑ∞Îßå Ï∂îÍ∞Ä
            const { id: tempId, ...dataWithoutId } = change.data;
            toInsert.push(dataWithoutId);
        }
        else if (change.type === 'update') toUpdate.set(change.data.id, change.data);
        else if (change.type === 'delete' && typeof id === 'number') toDelete.push(id);
    }
    const holidaysToAdd = Array.from(unsavedHolidayChanges.toAdd).map(date => ({ date }));
    const holidaysToRemove = Array.from(unsavedHolidayChanges.toRemove);

    try {
        const promises = [];
        if (toInsert.length > 0) {
            console.log('Inserting schedules:', toInsert);
            promises.push(db.from('schedules').insert(toInsert));
        }
        if (toDelete.length > 0) promises.push(db.from('schedules').delete().in('id', toDelete));
        if (toUpdate.size > 0) promises.push(...Array.from(toUpdate.values()).map(item => 
            db.from('schedules')
              .update({ date: item.date, status: item.status, sort_order: item.sort_order })
              .eq('id', item.id)
        ));
        if (holidaysToAdd.length > 0) promises.push(db.from('company_holidays').insert(holidaysToAdd));
        if (holidaysToRemove.length > 0) promises.push(db.from('company_holidays').delete().in('date', holidaysToRemove));
        const results = await Promise.all(promises);
        for (const res of results) if (res.error) throw res.error;
        alert('Ïä§ÏºÄÏ§Ñ Î∞è Ìú¥Î¨¥Ïùº Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        await loadAndRenderScheduleData(state.schedule.currentDate);
    } catch (error) {
        console.error('Ïä§ÏºÄÏ§Ñ Ï†ÄÏû• Ïã§Ìå®:', error);
        alert(`Ïä§ÏºÄÏ§Ñ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}`);
    } finally {
        updateSaveButtonState();
    }
}

function handleAddNewTeam() {
    const newTeamHtml = getTeamHtml({ id: `new-${Date.now()}`, name: 'ÏÉàÎ°úÏö¥ ÌåÄ', members: [] }, getFilteredEmployees());
    _('.unassigned-group').insertAdjacentHTML('beforebegin', newTeamHtml);
    const newTeamEl = _('.unassigned-group').previousElementSibling;
    const deleteBtn = newTeamEl.querySelector('.delete-team-btn');
    if (deleteBtn) deleteBtn.addEventListener('click', handleDeleteTeam);
    initializeSortableAndDraggable();
}

function handleDeleteTeam(e) {
    const teamId = e.target.closest('.delete-team-btn').dataset.teamId;
    if (!teamId) return;
    if (confirm("Ïù¥ ÌåÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? ÌåÄÏóê ÏÜçÌïú ÏßÅÏõêÏùÄ 'ÎØ∏ÏßÄÏ†ï ÏßÅÏõê'ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.")) {
        const teamEl = _(`.team-group[data-team-id="${teamId}"]`);
        if (teamEl) {
            teamEl.querySelectorAll('.draggable-employee, .list-spacer').forEach(member => _('#unassigned-list').appendChild(member));
            teamEl.remove();
        }
    }
}

function handleAddSeparator() {
    _('#unassigned-list').insertAdjacentHTML('beforeend', getSeparatorHtml());
}

function handleAddSpacer() {
    _('#unassigned-list').insertAdjacentHTML('beforeend', getSpacerHtml());
}

function handleDeleteSpacer(e) {
    if (e.target.matches('.delete-spacer-btn, .delete-separator-btn')) {
        e.target.closest('[data-type]').remove();
    }
}

async function handleSaveTeamLayout() {
    const saveBtn = _('#save-team-layout-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Ï†ÄÏû• Ï§ë...';
    const layoutData = [];
    document.querySelectorAll('#team-list-container .team-group').forEach(teamEl => {
        if (teamEl.classList.contains('unassigned-group')) return;
        const teamId = teamEl.dataset.teamId;
        const teamName = teamEl.querySelector('.team-header-input').value;
        const members = [];
        teamEl.querySelectorAll('.team-member-list > div').forEach(memberEl => {
            const type = memberEl.dataset.type;
            if (type === 'employee') members.push(parseInt(memberEl.dataset.employeeId, 10));
            else if (type === 'separator') members.push('---separator---');
            else if (type === 'spacer') members.push('---spacer---');
        });
        layoutData.push({ id: teamId, name: teamName, members });
    });
    const month = dayjs(state.schedule.currentDate).format('YYYY-MM-01');
    const managerUuid = state.currentUser?.auth_uuid;
    if (!managerUuid) {
        alert('Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
        saveBtn.disabled = false;
        saveBtn.textContent = 'ÌåÄ/ÏàúÏÑú Ï†ÄÏû•';
        return;
    }
    try {
        const { error } = await db.from('team_layouts').upsert({ month, layout_data: layoutData, manager_id: managerUuid }, { onConflict: 'month' });
        if (error) throw error;
        alert('ÌåÄ/ÏßÅÏõê ÏàúÏÑúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        await loadAndRenderScheduleData(state.schedule.currentDate);
    } catch (error) {
        console.error('ÌåÄ Î†àÏù¥ÏïÑÏõÉ Ï†ÄÏû• Ïã§Ìå®:', error);
        alert(`ÌåÄ/ÏßÅÏõê ÏàúÏÑú Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ÌåÄ/ÏàúÏÑú Ï†ÄÏû•';
    }
}

function handleDepartmentFilterChange(e) {
    const checkbox = e.target;
    if (checkbox.matches('.dept-filter-checkbox')) {
        const deptId = parseInt(checkbox.value);
        if (checkbox.checked) state.schedule.activeDepartmentFilters.add(deptId);
        else state.schedule.activeDepartmentFilters.delete(deptId);
        renderCalendar();
        renderScheduleSidebar();
    }
}

// ‚ú® Í∞úÏÑ†: ÏÇ¨Ïù¥ÎìúÎ∞îÏóêÏÑú Îã¨Î†•ÏúºÎ°ú ÎìúÎûòÍ∑∏ Í∞ÄÎä•ÌïòÎèÑÎ°ù ÏàòÏ†ï
function initializeDayDragDrop(dayEl, dateStr) {
    const eventContainer = dayEl.querySelector('.day-events');
    if (!eventContainer) return;
    
    if (eventContainer.sortableInstance) {
        eventContainer.sortableInstance.destroy();
    }
    
    // ‚ú® ÎÇ†Ïßú Ïπ∏Ïóê ÎìúÎ°≠Ï°¥ ÏÑ§Ï†ï
    eventContainer.sortableInstance = new Sortable(eventContainer, {
        group: {
            name: 'calendar-group',
            pull: true,
            put: ['sidebar-group', 'calendar-group'] // ‚ú® Î™ÖÏãúÏ†ÅÏúºÎ°ú Î∞õÏùÑ Í∑∏Î£π ÏßÄÏ†ï
        },
        draggable: '.event-card, .draggable-employee',
        animation: 150,
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        chosenClass: 'sortable-chosen',
        dragoverBubble: true,
        delay: 100,
        delayOnTouchOnly: false,
        forceFallback: false, // ‚ú® HTML5 ÎìúÎûòÍ∑∏ ÏÇ¨Ïö©
        fallbackTolerance: 5,
        emptyInsertThreshold: 30,
        
        onStart(evt) {
            isDragging = true;
            dragStartTime = Date.now();
            document.body.style.userSelect = 'none';
            document.querySelectorAll('.day-events').forEach(el => {
                el.style.minHeight = '100px';
                el.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
                el.style.border = '2px dashed rgba(59, 130, 246, 0.3)';
            });
            console.log('üìÖ Calendar drag started');
        },
        
        onEnd(evt) {
            setTimeout(() => {
                isDragging = false;
            }, 100);
            document.body.style.userSelect = '';
            document.querySelectorAll('.day-events').forEach(el => {
                el.style.minHeight = '';
                el.style.backgroundColor = '';
                el.style.border = '';
            });
            console.log('üìÖ Calendar drag ended');
        },
        
        onUpdate(evt) {
            console.log('üìÖ Calendar onUpdate');
            updateScheduleSortOrders(dateStr);
            updateSaveButtonState();
        },
        
        onAdd(evt) {
            console.log('üéØ Calendar onAdd triggered! Date:', dateStr);
            const employeeEl = evt.item;
            
            // event-cardÏù∏ Í≤ΩÏö∞Îäî Îã§Î•∏ ÎÇ†ÏßúÏóêÏÑú Ïò® Í≤É
            if (employeeEl.classList.contains('event-card')) {
                console.log('‚úÖ Moved from another date');
                updateScheduleSortOrders(dateStr);
                updateSaveButtonState();
                return;
            }
            
            // draggable-employeeÏù∏ Í≤ΩÏö∞ ÏÇ¨Ïù¥ÎìúÎ∞îÏóêÏÑú Ïò® Í≤É
            const empId = parseInt(employeeEl.dataset.employeeId, 10);
            console.log('üìù Dropped employee ID:', empId);
            
            if (isNaN(empId) || !empId) {
                console.log('‚ùå Invalid employee ID, removing element');
                employeeEl.remove();
                return;
            }
            
            const employee = state.management.employees.find(e => e.id === empId);
            if (!employee) {
                console.log('‚ùå Employee not found, removing element');
                employeeEl.remove();
                return;
            }
            
            console.log('‚úÖ Found employee:', employee.name);
            
            let schedule = state.schedule.schedules.find(s => s.date === dateStr && s.employee_id === empId);
            
            if (!schedule) {
                const maxOrder = Math.max(
                    -1,
                    ...state.schedule.schedules
                        .filter(s => s.date === dateStr)
                        .map(s => s.sort_order)
                        .filter(o => o !== null && o !== undefined)
                );
                
                const tempId = `temp-${Date.now()}-${empId}`;
                schedule = {
                    id: tempId,
                    date: dateStr,
                    employee_id: empId,
                    status: state.schedule.viewMode === 'working' ? 'Í∑ºÎ¨¥' : 'Ìú¥Î¨¥',
                    sort_order: maxOrder + 1
                };
                state.schedule.schedules.push(schedule);
                unsavedChanges.set(tempId, { type: 'new', data: schedule });
                console.log('‚úÖ Created new schedule:', schedule);
            } else {
                const newStatus = state.schedule.viewMode === 'working' ? 'Í∑ºÎ¨¥' : 'Ìú¥Î¨¥';
                if (schedule.status !== newStatus) {
                    schedule.status = newStatus;
                    unsavedChanges.set(schedule.id, { type: 'update', data: schedule });
                    console.log('‚úÖ Updated schedule status:', schedule);
                }
            }
            
            employeeEl.remove();
            renderCalendar();
            updateSaveButtonState();
        },
    });
}

function getWorkingEmployeesOnDate(dateStr) {
    const filteredEmployees = getFilteredEmployees();
    const masterOrderMap = new Map();
    state.schedule.teamLayout.data.flatMap(team => team.members)
        .forEach((id, index) => {
            if (typeof id === 'number') masterOrderMap.set(id, index);
        });

    const workingEmps = [];
    
    filteredEmployees.forEach(emp => {
        const explicitSchedule = state.schedule.schedules.find(s => s.date === dateStr && s.employee_id === emp.id);
        
        if (explicitSchedule) {
            if (explicitSchedule.status === 'Í∑ºÎ¨¥') {
                workingEmps.push(emp);
            }
            return;
        }
        
        const isLeave = state.management.leaveRequests.some(r => r.status === 'approved' && r.employee_id === emp.id && r.dates.includes(dateStr));
        const isHoliday = state.schedule.companyHolidays.has(dateStr);
        const isDefaultOff = dayjs(dateStr).day() === 0;
        
        if (!isLeave && !isHoliday && !isDefaultOff) {
            workingEmps.push(emp);
        }
    });

    workingEmps.sort((a, b) => {
        const scheduleA = state.schedule.schedules.find(s => s.date === dateStr && s.employee_id === a.id);
        const scheduleB = state.schedule.schedules.find(s => s.date === dateStr && s.employee_id === b.id);

        const orderA = scheduleA?.sort_order;
        const orderB = scheduleB?.sort_order;

        if (orderA !== null && typeof orderA !== 'undefined' && orderB !== null && typeof orderB !== 'undefined') return orderA - orderB;
        if (orderA !== null && typeof orderA !== 'undefined') return -1;
        if (orderB !== null && typeof orderB !== 'undefined') return 1;

        const masterIndexA = masterOrderMap.get(a.id) ?? 999;
        const masterIndexB = masterOrderMap.get(b.id) ?? 999;
        
        return masterIndexA - masterIndexB;
    });

    return workingEmps;
}

function getOffEmployeesOnDate(dateStr) {
    const filteredEmployees = getFilteredEmployees();
    const masterOrderMap = new Map();
    state.schedule.teamLayout.data.flatMap(team => team.members)
        .forEach((id, index) => {
            if (typeof id === 'number') masterOrderMap.set(id, index);
        });

    const offEmps = [];
    
    filteredEmployees.forEach(emp => {
        const explicitSchedule = state.schedule.schedules.find(s => s.date === dateStr && s.employee_id === emp.id);
        
        if (explicitSchedule && explicitSchedule.status === 'Ìú¥Î¨¥') {
            offEmps.push({ employee: emp, schedule: explicitSchedule, type: 'Ìú¥Î¨¥' });
            return;
        }
        
        if (!explicitSchedule) {
            const isLeave = state.management.leaveRequests.some(r => r.status === 'approved' && r.employee_id === emp.id && r.dates.includes(dateStr));
            if (isLeave) {
                offEmps.push({ employee: emp, schedule: null, type: 'leave' });
            }
        }
    });
    
    offEmps.sort((a, b) => {
        const orderA = a.schedule?.sort_order;
        const orderB = b.schedule?.sort_order;

        if (orderA !== null && typeof orderA !== 'undefined' && orderB !== null && typeof orderB !== 'undefined') return orderA - orderB;
        if (orderA !== null && typeof orderA !== 'undefined') return -1;
        if (orderB !== null && typeof orderB !== 'undefined') return 1;

        const masterIndexA = masterOrderMap.get(a.employee.id) ?? 999;
        const masterIndexB = masterOrderMap.get(b.employee.id) ?? 999;
        
        return masterIndexA - masterIndexB;
    });

    return offEmps;
}

// ‚ú® Í∞úÏÑ†: ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Î•º Îçî Ï†ïÍµêÌïòÍ≤å Ï≤òÎ¶¨
function handleEventCardClick(e) {
    const card = e.target.closest('.event-card');
    if (!card) return;
    
    // ‚ú® ÎìúÎûòÍ∑∏ Ï§ëÏù¥Í±∞ÎÇò ÎìúÎûòÍ∑∏ ÏßÅÌõÑÎ©¥ ÌÅ¥Î¶≠ Î¨¥Ïãú
    if (isDragging || (Date.now() - dragStartTime < 200)) {
        console.log('Click ignored: dragging or just after drag');
        return;
    }
    
    const dateStr = card.closest('.calendar-day').dataset.date;
    const empId = parseInt(card.dataset.employeeId);
    const type = card.dataset.type;
    
    // Ïó∞Ï∞®Îäî ÌÅ¥Î¶≠ Î∂àÍ∞Ä
    if (type === 'leave') {
        return;
    }
    
    // ‚ú® Ïπ¥Îìú ÌÅ¥Î¶≠: ÏÉÅÌÉú Ï†ÑÌôò
    console.log('Card clicked:', empId, 'on', dateStr);
    
    let schedule = state.schedule.schedules.find(s => s.date === dateStr && s.employee_id === empId);
    
    if (schedule) {
        // Í∏∞Ï°¥ Ïä§ÏºÄÏ§Ñ: ÏÉÅÌÉú Ï†ÑÌôò
        schedule.status = schedule.status === 'Í∑ºÎ¨¥' ? 'Ìú¥Î¨¥' : 'Í∑ºÎ¨¥';
        unsavedChanges.set(schedule.id, { type: 'update', data: schedule });
        console.log('Updated schedule:', schedule);
    } else {
        // ÏÉà Ïä§ÏºÄÏ§Ñ ÏÉùÏÑ±
        const currentlyWorking = getWorkingEmployeesOnDate(dateStr).some(emp => emp.id === empId);
        const newStatus = currentlyWorking ? 'Ìú¥Î¨¥' : 'Í∑ºÎ¨¥';
        
        const existingOrders = state.schedule.schedules
            .filter(s => s.date === dateStr)
            .map(s => s.sort_order)
            .filter(o => o !== null && o !== undefined);
        const maxOrder = existingOrders.length > 0 ? Math.max(...existingOrders) : -1;
        
        const tempId = `temp-${Date.now()}-${empId}`;
        const newSchedule = {
            id: tempId,
            date: dateStr,
            employee_id: empId,
            status: newStatus,
            sort_order: maxOrder + 1
        };
        state.schedule.schedules.push(newSchedule);
        unsavedChanges.set(tempId, { type: 'new', data: newSchedule });
        console.log('Created schedule:', newSchedule);
    }
    
    renderCalendar();
    updateSaveButtonState();
}

function handleDateNumberClick(e) {
    const target = e.target;
    
    if (!target.classList.contains('day-number')) return;
    
    e.stopPropagation();
    
    const dayEl = target.closest('.calendar-day');
    if (!dayEl) return;
    
    const clickedDate = dayEl.dataset.date;
    
    console.log('Date clicked:', clickedDate, 'Mode:', state.schedule.viewMode);
    
    const allEmployees = getFilteredEmployees();
    
    if (state.schedule.viewMode === 'working') {
        allEmployees.forEach((emp, index) => {
            let schedule = state.schedule.schedules.find(s => s.date === clickedDate && s.employee_id === emp.id);
            
            if (schedule) {
                if (schedule.status !== 'Ìú¥Î¨¥') {
                    schedule.status = 'Ìú¥Î¨¥';
                    schedule.sort_order = index;
                    unsavedChanges.set(schedule.id, { type: 'update', data: schedule });
                }
            } else {
                const tempId = `temp-${Date.now()}-${emp.id}`;
                const newSchedule = {
                    id: tempId,
                    date: clickedDate,
                    employee_id: emp.id,
                    status: 'Ìú¥Î¨¥',
                    sort_order: index
                };
                state.schedule.schedules.push(newSchedule);
                unsavedChanges.set(tempId, { type: 'new', data: newSchedule });
            }
        });
        
        state.schedule.companyHolidays.add(clickedDate);
        if (unsavedHolidayChanges.toRemove.has(clickedDate)) {
            unsavedHolidayChanges.toRemove.delete(clickedDate);
        } else {
            unsavedHolidayChanges.toAdd.add(clickedDate);
        }
    } 
    else {
        allEmployees.forEach((emp, index) => {
            let schedule = state.schedule.schedules.find(s => s.date === clickedDate && s.employee_id === emp.id);
            
            if (schedule) {
                if (schedule.status !== 'Í∑ºÎ¨¥') {
                    schedule.status = 'Í∑ºÎ¨¥';
                    schedule.sort_order = index;
                    unsavedChanges.set(schedule.id, { type: 'update', data: schedule });
                }
            } else {
                const tempId = `temp-${Date.now()}-${emp.id}`;
                const newSchedule = {
                    id: tempId,
                    date: clickedDate,
                    employee_id: emp.id,
                    status: 'Í∑ºÎ¨¥',
                    sort_order: index
                };
                state.schedule.schedules.push(newSchedule);
                unsavedChanges.set(tempId, { type: 'new', data: newSchedule });
            }
        });
        
        state.schedule.companyHolidays.delete(clickedDate);
        if (unsavedHolidayChanges.toAdd.has(clickedDate)) {
            unsavedHolidayChanges.toAdd.delete(clickedDate);
        } else {
            unsavedHolidayChanges.toRemove.add(clickedDate);
        }
    }
    
    renderCalendar();
    updateSaveButtonState();
}

function renderCalendar() {
    const container = _('#pure-calendar');
    if (!container) {
        console.error('Calendar container not found');
        return;
    }
    
    const currentDate = dayjs(state.schedule.currentDate);
    const year = currentDate.year();
    const month = currentDate.month();
    
    const firstDay = dayjs(new Date(year, month, 1));
    const lastDay = dayjs(new Date(year, month + 1, 0));
    const startDate = firstDay.startOf('week');
    const endDate = lastDay.endOf('week');
    
    let calendarHTML = '<div class="calendar-grid">';
    
    const weekDays = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
    weekDays.forEach((day, idx) => {
        let colorClass = '';
        if (idx === 0) colorClass = 'text-red-500';
        else if (idx === 6) colorClass = 'text-blue-500';
        calendarHTML += `<div class="calendar-header ${colorClass}">${day}</div>`;
    });
    
    let currentLoop = startDate.clone();
    while (currentLoop.valueOf() <= endDate.valueOf()) {
        const dateStr = currentLoop.format('YYYY-MM-DD');
        const dayNum = currentLoop.date();
        const isCurrentMonth = currentLoop.month() === month;
        const isToday = currentLoop.format('YYYY-MM-DD') === dayjs().format('YYYY-MM-DD');
        const isSunday = currentLoop.day() === 0;
        const isSaturday = currentLoop.day() === 6;
        const isHoliday = state.schedule.companyHolidays.has(dateStr);
        
        let dayClasses = 'calendar-day';
        if (!isCurrentMonth) dayClasses += ' other-month';
        if (isToday) dayClasses += ' today';
        if (isHoliday) dayClasses += ' company-holiday';
        if (isSunday) dayClasses += ' sunday-col';
        
        let numberClass = 'day-number';
        if (isSunday) numberClass += ' text-red-500';
        else if (isSaturday) numberClass += ' text-blue-500';
        
        let eventsHTML = '';
        if (state.schedule.viewMode === 'working') {
            const employees = getWorkingEmployeesOnDate(dateStr);
            eventsHTML = employees.map(emp => {
                const schedule = state.schedule.schedules.find(s => s.date === dateStr && s.employee_id === emp.id);
                const scheduleId = schedule?.id || '';
                const deptColor = getDepartmentColor(emp.departments?.id);
                // ‚ú® ÏÇ≠Ï†ú Î≤ÑÌäº Ï†úÍ±∞
                return `<div class="event-card event-working" data-employee-id="${emp.id}" data-schedule-id="${scheduleId}" data-type="working">
                    <span class="event-dot" style="background-color: ${deptColor};"></span>
                    <span class="event-name">${emp.name}</span>
                </div>`;
            }).join('');
        } else {
            const offData = getOffEmployeesOnDate(dateStr);
            eventsHTML = offData.map(item => {
                const scheduleId = item.schedule?.id || '';
                const type = item.type;
                const deptColor = getDepartmentColor(item.employee.departments?.id);
                const eventClass = type === 'leave' ? 'event-leave' : 'event-off';
                // ‚ú® ÏÇ≠Ï†ú Î≤ÑÌäº Ï†úÍ±∞
                return `<div class="event-card ${eventClass}" data-employee-id="${item.employee.id}" data-schedule-id="${scheduleId}" data-type="${type}">
                    <span class="event-dot" style="background-color: ${deptColor};"></span>
                    <span class="event-name">${item.employee.name}</span>
                </div>`;
            }).join('');
        }
        
        calendarHTML += `
            <div class="${dayClasses}" data-date="${dateStr}">
                <div class="day-header">
                    <span class="${numberClass}">${dayNum}</span>
                </div>
                <div class="day-events">${eventsHTML}</div>
            </div>`;
        
        currentLoop = currentLoop.add(1, 'day');
    }
    
    calendarHTML += '</div>';
    container.innerHTML = calendarHTML;
    
    // ‚ú® Î™®Îì† ÎÇ†ÏßúÏóê ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ï¥àÍ∏∞Ìôî
    document.querySelectorAll('.calendar-day').forEach(dayEl => {
        const dateStr = dayEl.dataset.date;
        initializeDayDragDrop(dayEl, dateStr);
    });
    
    // ‚ú® Ïù¥Î≤§Ìä∏ ÏúÑÏûÑÏúºÎ°ú ÌÅ¥Î¶≠ Ï≤òÎ¶¨
    container.removeEventListener('click', handleCalendarClick);
    container.addEventListener('click', handleCalendarClick);
    
    console.log('Calendar rendered successfully');
}

// ‚ú® Îã¨Î†• ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ Î∂ÑÎ¶¨
function handleCalendarClick(e) {
    // ÎÇ†Ïßú Ïà´Ïûê ÌÅ¥Î¶≠
    if (e.target.classList.contains('day-number')) {
        handleDateNumberClick(e);
        return;
    }
    
    // Ïù¥Î≤§Ìä∏ Ïπ¥Îìú ÌÅ¥Î¶≠ (ÎìúÎûòÍ∑∏ ÏïÑÎãê ÎïåÎßå)
    const card = e.target.closest('.event-card');
    if (card && !isDragging) {
        handleEventCardClick(e);
        return;
    }
}

function navigateMonth(direction) {
    const totalChanges = unsavedChanges.size + unsavedHolidayChanges.toAdd.size + unsavedHolidayChanges.toRemove.size;
    if (totalChanges > 0 && !confirm("Ï†ÄÏû•ÎêòÏßÄ ÏïäÏùÄ Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏûàÏäµÎãàÎã§. Îã§Î•∏ Îã¨Î°ú Ïù¥ÎèôÌïòÎ©¥ Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏÇ¨ÎùºÏßëÎãàÎã§. Ï†ïÎßê Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
        return;
    }
    
    const current = dayjs(state.schedule.currentDate);
    let newDate;
    if (direction === 'prev') newDate = current.subtract(1, 'month');
    else if (direction === 'next') newDate = current.add(1, 'month');
    else newDate = dayjs();
    
    state.schedule.currentDate = newDate.format('YYYY-MM-DD');
    loadAndRenderScheduleData(state.schedule.currentDate);
}

async function loadAndRenderScheduleData(date) {
    if (state.schedule.activeReorder.date) {
        const prevDayEl = _(`.calendar-day[data-date="${state.schedule.activeReorder.date}"]`);
        if (prevDayEl) {
            prevDayEl.classList.remove('reordering-active');
        }
        state.schedule.activeReorder.sortable?.destroy();
        state.schedule.activeReorder.date = null;
        state.schedule.activeReorder.sortable = null;
    }
    
    unsavedChanges.clear();
    unsavedHolidayChanges = { toAdd: new Set(), toRemove: new Set() };
    updateSaveButtonState();
    
    const currentMonth = dayjs(date).format('YYYY-MM-01');
    const startOfMonth = dayjs(date).startOf('month').format('YYYY-MM-DD');
    const endOfMonth = dayjs(date).endOf('month').format('YYYY-MM-DD');
    
    console.log('Loading data for:', { currentMonth, startOfMonth, endOfMonth });
    
    try {
        const [layoutRes, scheduleRes, holidayRes] = await Promise.all([
            db.from('team_layouts').select('layout_data').lte('month', currentMonth).order('month', { ascending: false }).limit(1),
            db.from('schedules').select('*').gte('date', startOfMonth).lte('date', endOfMonth),
            db.from('company_holidays').select('date').gte('date', startOfMonth).lte('date', endOfMonth)
        ]);
        
        console.log('Data loaded:', { layoutRes, scheduleRes, holidayRes });
        
        if (layoutRes.error) throw layoutRes.error;
        if (scheduleRes.error) throw scheduleRes.error;
        if (holidayRes.error) throw holidayRes.error;

        const latestLayout = layoutRes.data?.[0];
        state.schedule.teamLayout = { 
            month: dayjs(date).format('YYYY-MM'), 
            data: latestLayout ? latestLayout.layout_data : [] 
        };
        state.schedule.schedules = scheduleRes.data || [];
        state.schedule.companyHolidays = new Set((holidayRes.data || []).map(h => h.date));
        
        console.log('State updated:', {
            teamLayout: state.schedule.teamLayout,
            schedulesCount: state.schedule.schedules.length,
            holidaysCount: state.schedule.companyHolidays.size
        });
        
        const titleEl = _('#calendar-title');
        if (titleEl) {
            titleEl.textContent = dayjs(date).format('YYYYÎÖÑ MÏõî');
        }
        
        // ‚ú® ÏàúÏÑú Î≥ÄÍ≤Ω: Îã¨Î†•ÏùÑ Î®ºÏ†Ä Î†åÎçîÎßÅ
        renderCalendar();
        
        // ‚ú® Í∑∏ Îã§Ïùå ÏÇ¨Ïù¥ÎìúÎ∞î Î†åÎçîÎßÅ (Ïù¥Îïå Îã¨Î†•Ïùò day-eventsÍ∞Ä Ï°¥Ïû¨Ìï®)
        await renderScheduleSidebar();
        
        console.log('Rendering complete');
    } catch (error) {
        console.error("Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:", error);
        alert('Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
    }
}

function initializeSortableAndDraggable() {
    state.schedule.sortableInstances.forEach(s => s.destroy());
    state.schedule.sortableInstances = [];
    
    const container = _('#team-list-container');
    if (container) {
        new Sortable(container, { 
            group: 'teams', 
            handle: '.handle', 
            animation: 150, 
            ghostClass: 'sortable-ghost', 
            filter: '.unassigned-group' 
        });
    }
    
    // ‚ú® ÏÇ¨Ïù¥ÎìúÎ∞î ÏßÅÏõê Î¶¨Ïä§Ìä∏
    document.querySelectorAll('.team-member-list').forEach((list, index) => {
        const sortableInstance = new Sortable(list, { 
            group: {
                name: 'sidebar-group', // ‚ú® Í≥†Ïú†Ìïú Í∑∏Î£πÎ™Ö
                pull: 'clone', // ‚ú® Î≥µÏÇ¨ Î™®Îìú (ÏÇ¨Ïù¥ÎìúÎ∞îÏóê Ïú†ÏßÄ)
                put: true
            },
            draggable: '.draggable-employee, .list-spacer',
            animation: 150, 
            ghostClass: 'sortable-ghost',
            sort: true,
            forceFallback: false, // ‚ú® HTML5 ÎìúÎûòÍ∑∏ ÏÇ¨Ïö©
            
            onStart(evt) {
                isDragging = true;
                dragStartTime = Date.now();
                document.body.style.userSelect = 'none';
                const empId = evt.item.dataset.employeeId;
                console.log(`üëâ [Sidebar ${index}] Drag started - Employee ID: ${empId}`);
                
                // ‚ú® Îã¨Î†• ÏòÅÏó≠ Í∞ïÏ°∞
                document.querySelectorAll('.day-events').forEach(el => {
                    el.style.minHeight = '100px';
                    el.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
                    el.style.border = '2px dashed rgba(59, 130, 246, 0.3)';
                });
            },
            
            onEnd(evt) {
                setTimeout(() => {
                    isDragging = false;
                }, 100);
                document.body.style.userSelect = '';
                
                const toClasses = evt.to.className;
                const isCalendar = toClasses.includes('day-events');
                console.log(`üëâ [Sidebar ${index}] Drag ended - To: ${toClasses}, isCalendar: ${isCalendar}`);
                
                // ‚ú® Îã¨Î†• Í∞ïÏ°∞ Ï†úÍ±∞
                document.querySelectorAll('.day-events').forEach(el => {
                    el.style.minHeight = '';
                    el.style.backgroundColor = '';
                    el.style.border = '';
                });
            },
            
            onClone(evt) {
                console.log(`üëâ [Sidebar ${index}] Employee cloned for drag`);
            },
        });
        
        state.schedule.sortableInstances.push(sortableInstance);
    });
    
    console.log('‚úÖ Initialized', state.schedule.sortableInstances.length, 'sidebar sortable instances');
    console.log('‚úÖ Calendar has', document.querySelectorAll('.day-events').length, 'droppable day-events');
    
    // ‚ú® ÎîîÎ≤ÑÍπÖ: Ï≤´ Î≤àÏß∏ day-eventsÏùò Sortable ÏÑ§Ï†ï ÌôïÏù∏
    const firstDayEvent = document.querySelector('.day-events');
    if (firstDayEvent && firstDayEvent.sortableInstance) {
        console.log('‚úÖ First day-events Sortable group:', firstDayEvent.sortableInstance.option('group'));
    } else {
        console.log('‚ùå First day-events has no Sortable instance!');
    }
}

async function renderScheduleSidebar() {
    const sidebar = _('#schedule-sidebar-area');
    if (!sidebar) return;
    const { teamLayout } = state.schedule;
    const filteredEmployees = getFilteredEmployees();
    let teamData = teamLayout.data || [];
    
    const assignedEmployeeIds = new Set(teamData.flatMap(team => team.members.filter(m => typeof m === 'number')));
    const unassignedEmployees = filteredEmployees.filter(emp => !assignedEmployeeIds.has(emp.id));

    sidebar.innerHTML = `
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center mb-2 pb-2 border-b">
                <h3 class="font-bold">ÌåÄ / ÏßÅÏõê Î™©Î°ù</h3>
                <button id="save-team-layout-btn" class="text-sm px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">ÌåÄ/ÏàúÏÑú Ï†ÄÏû•</button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2" id="team-list-container">
                ${teamData.map(team => getTeamHtml(team, filteredEmployees)).join('')}
                <div class="team-group unassigned-group">
                    <div class="team-header text-sm font-semibold text-gray-600 p-2">ÎØ∏ÏßÄÏ†ï ÏßÅÏõê</div>
                    <div class="team-member-list" id="unassigned-list">${unassignedEmployees.map(emp => getEmployeeHtml(emp)).join('')}</div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button id="add-new-team-btn" class="w-full mt-2 text-sm py-2 px-2 border border-dashed rounded-lg text-gray-600 hover:bg-gray-100">+ ÏÉà ÌåÄ Ï∂îÍ∞Ä</button>
                <button id="add-separator-btn" class="w-full mt-2 text-sm py-2 px-2 border border-dashed rounded-lg text-gray-600 hover:bg-gray-100">-- Íµ¨Î∂ÑÏÑ† Ï∂îÍ∞Ä</button>
                <button id="add-spacer-btn" class="col-span-2 w-full mt-2 text-sm py-2 px-2 border border-dashed rounded-lg text-gray-600 hover:bg-gray-100">üìÑ Îπà Ïπ∏ Ï∂îÍ∞Ä</button>
            </div>
        </div>`;
    _('#add-new-team-btn').addEventListener('click', handleAddNewTeam);
    _('#add-separator-btn').addEventListener('click', handleAddSeparator);
    _('#add-spacer-btn').addEventListener('click', handleAddSpacer);
    _('#save-team-layout-btn').addEventListener('click', handleSaveTeamLayout);
    sidebar.addEventListener('click', handleDeleteSpacer);
    document.querySelectorAll('.delete-team-btn').forEach(btn => btn.addEventListener('click', handleDeleteTeam));
    initializeSortableAndDraggable();
}

export async function renderScheduleManagement(container) {
    console.log('renderScheduleManagement called');
    
    if (!state.schedule) {
        state.schedule = {
            currentDate: dayjs().format('YYYY-MM-DD'),
            viewMode: 'working',
            teamLayout: { month: '', data: [] },
            schedules: [],
            activeDepartmentFilters: new Set(),
            companyHolidays: new Set(),
            activeReorder: { date: null, sortable: null },
            sortableInstances: []
        };
    }
    
    if (!state.management) {
        console.error('state.management is not initialized');
        container.innerHTML = '<div class="p-4 text-red-600">Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.</div>';
        return;
    }
    
    const departments = state.management.departments || [];
    const deptFilterHtml = departments.map(dept => 
        `<div class="flex items-center">
            <input id="dept-${dept.id}" type="checkbox" value="${dept.id}" class="dept-filter-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <label for="dept-${dept.id}" class="ml-2 text-sm text-gray-700">${dept.name}</label>
        </div>`
    ).join('');
    
    container.innerHTML = `
        <div class="schedule-grid">
            <div class="schedule-main-content">
                <div class="flex justify-between items-center mb-2 pb-2 border-b">
                    <div id="schedule-view-toggle" class="flex rounded-md shadow-sm" role="group">
                        <button type="button" data-mode="working" class="schedule-view-btn active rounded-l-lg">Í∑ºÎ¨¥Ïûê Î≥¥Í∏∞</button>
                        <button type="button" data-mode="off" class="schedule-view-btn rounded-r-md">Ìú¥Î¨¥Ïûê Î≥¥Í∏∞</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="print-schedule-btn">üñ®Ô∏è Ïù∏ÏáÑÌïòÍ∏∞</button>
                        <button id="revert-schedule-btn" disabled>üîÑ ÎêòÎèåÎ¶¨Í∏∞</button>
                        <button id="save-schedule-btn" disabled>üíæ Ïä§ÏºÄÏ§Ñ Ï†ÄÏû•</button>
                    </div>
                </div>
                <div id="department-filters" class="flex items-center flex-wrap gap-4 my-4 text-sm">
                    <span class="font-semibold">Î∂ÄÏÑú ÌïÑÌÑ∞:</span>${deptFilterHtml}
                </div>
                <div class="calendar-controls flex items-center justify-between mb-4">
                    <button id="calendar-prev" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">‚óÄ Ïù¥Ï†Ñ</button>
                    <h2 id="calendar-title" class="text-2xl font-bold"></h2>
                    <button id="calendar-next" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Îã§Ïùå ‚ñ∂</button>
                    <button id="calendar-today" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Ïò§Îäò</button>
                </div>
                <div id="pure-calendar"></div>
            </div>
            <div id="schedule-sidebar-area"></div>
        </div>
    `;
    
    console.log('HTML rendered');
    
    _('#schedule-view-toggle')?.addEventListener('click', handleViewModeChange);
    _('#department-filters')?.addEventListener('change', handleDepartmentFilterChange);
    _('#save-schedule-btn')?.addEventListener('click', handleSaveSchedules);
    _('#revert-schedule-btn')?.addEventListener('click', handleRevertChanges);
    _('#calendar-prev')?.addEventListener('click', () => navigateMonth('prev'));
    _('#calendar-next')?.addEventListener('click', () => navigateMonth('next'));
    _('#calendar-today')?.addEventListener('click', () => navigateMonth('today'));
    _('#print-schedule-btn')?.addEventListener('click', handlePrintSchedule);
    
    console.log('Event listeners attached');
    
    try {
        await loadAndRenderScheduleData(state.schedule.currentDate);
        updateViewModeButtons();
        console.log('Initial render complete');
    } catch (error) {
        console.error('Error in initial render:', error);
        alert('Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎî©Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
    }
}

// ‚ú® Ïù∏ÏáÑ Ìï∏Îì§Îü¨ - Ï∫°Ï≥ê Î∞©ÏãùÏúºÎ°ú Î≥ÄÍ≤Ω
async function handlePrintSchedule() {
    const currentDate = dayjs(state.schedule.currentDate);
    const viewModeText = state.schedule.viewMode === 'working' ? 'Í∑ºÎ¨¥Ïûê Î™ÖÎã®' : 'Ìú¥Î¨¥Ïûê Î™ÖÎã®';
    
    // Îã¨Î†• ÏöîÏÜå
    const calendarEl = _('#pure-calendar');
    if (!calendarEl) {
        alert('Îã¨Î†•ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
    }
    
    try {
        // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        const printBtn = _('#print-schedule-btn');
        printBtn.disabled = true;
        printBtn.textContent = 'Ï∫°Ï≥ê Ï§ë...';
        
        // html2canvasÎ°ú Îã¨Î†• Ï∫°Ï≥ê
        const canvas = await html2canvas(calendarEl, {
            scale: 2, // Í≥†Ìï¥ÏÉÅÎèÑ
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false,
        });
        
        // ÏÉà Ï∞ΩÏóê Ïù¥ÎØ∏ÏßÄ ÌëúÏãú Î∞è Ïù∏ÏáÑ
        const imgData = canvas.toDataURL('image/png');
        const printWindow = window.open('', '_blank');
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${currentDate.format('YYYYÎÖÑ MÏõî')} Ïä§ÏºÄÏ§Ñ - ${viewModeText}</title>
                <style>
                    @page {
                        size: A4 landscape;
                        margin: 10mm;
                    }
                    * {
                        margin: 0;
                        padding: 0;
                    }
                    body {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        min-height: 100vh;
                        background: white;
                    }
                    .print-header {
                        text-align: center;
                        margin-bottom: 10px;
                    }
                    h1 {
                        font-size: 20pt;
                        font-weight: bold;
                        margin-bottom: 5px;
                    }
                    p {
                        font-size: 12pt;
                        color: #666;
                    }
                    img {
                        max-width: 100%;
                        height: auto;
                        display: block;
                    }
                    @media print {
                        body {
                            min-height: auto;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="print-header">
                    <h1>${currentDate.format('YYYYÎÖÑ MÏõî')} Ïä§ÏºÄÏ§Ñ</h1>
                    <p>${viewModeText}</p>
                </div>
                <img src="${imgData}" />
                <script>
                    window.onload = function() {
                        window.print();
                        // Ïù∏ÏáÑ ÏôÑÎ£å ÌõÑ Ï∞Ω Îã´Í∏∞
                        setTimeout(() => window.close(), 100);
                    };
                </script>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
    } catch (error) {
        console.error('Ï∫°Ï≥ê Ïã§Ìå®:', error);
        alert('Ï∫°Ï≥êÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
    } finally {
        // Î≤ÑÌäº Î≥µÍµ¨
        const printBtn = _('#print-schedule-btn');
        printBtn.disabled = false;
        printBtn.textContent = 'üñ®Ô∏è Ïù∏ÏáÑÌïòÍ∏∞';
    }
}